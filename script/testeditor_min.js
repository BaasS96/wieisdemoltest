var currenttest,rev;function listFiles(){fetch("listtests.php").then(function(a){var b=a.headers.get("content-type");if(b&&b.includes("application/json")&&a.ok)return a.json();throw new TypeError("Did not receive content-type application/json")}).then(function(a){for(var b=createMainPanel("file"),d=Object.keys(a),e=d.length,g=0;g<e;g++){var k=d[g],m=a[k];b.getElementsByClassName("rightpanel_content")[0].appendChild(createFileOpenSubPanel(k,m,g))}document.getElementById("holderright").appendChild(b)})}function getFileRevisions(a,b){fetch("listrevisions.php?test="+a).then(function(d){var e=d.headers.get("content-type");if(e&&e.includes("application/json")&&d.ok)return d.json();throw new TypeError("Did not receive content-type application/json")}).then(function(d){for(var e=d.length,g=0;g<e;g++){let k=d[g].split("_"),m=k[0]+"."+k[1]+"."+k[2]+"-"+k[3]+":"+k[4]+":"+k[5],n=document.createElement("div");n.className="rightpanel_sub_subcontentholder",n.innerHTML=g+1+" - "+m,n.setAttribute("test",a),n.setAttribute("revision",m),n.onclick=getData.bind(n),b.appendChild(n)}})}function loadData(a,b){cleareditor();var d=document.getElementById("test_name"),e=document.getElementById("lastsaved"),g=document.getElementById("questionholder");d.value=b,e.innerHTML=a.rev;var k=JSON.parse(a.data);k.forEach(function(m){for(var n=addquestion(m.title),q=0;q<m.answers.length;q++)addanswer(n,m.answers[q].title,m.answers[q].correct)},this)}function getData(a){var b,d;"function"==typeof this.getAttribute?(b=this.getAttribute("test"),d=this.getAttribute("revision")):(b=a.getAttribute("test"),d=a.getAttribute("revision")),currenttest=b,rev=d,fetch("getfile.php?file="+b+"&revision="+d).then(function(e){var g=e.headers.get("content-type");if(g&&g.includes("application/json")&&e.ok)return e.json();throw new TypeError("Did not receive content-type application/json")}).then(function(e){loadData(e,b)})}function listContestants(){let a=new XMLHttpRequest;a.open("GET","data/contestants.json"),a.addEventListener("load",function(){if(""!==this.responseText){var b;try{b=JSON.parse(this.responseText)}catch(e){return void console.log(e)}for(let e in b){let g=Object.keys(b[e])[0];var d=addgroup(g);for(let k of b[e][g]){let m=addContestant.bind(d);m(k)}}}}),a.send()}function createMainPanel(a){void 0===a&&(a="file");var b=document.createElement("div");b.className="rightpanel";var d=document.createElement("div");d.className="rightpanel_header";var e;e="file"===a?"<button type='button' class='showall_icon' title='Show contents' onclick='collapsePanel(this);'>&nbsp;</button> <span class='rightpanel_header_text'>Load file":"publishinfo"===a?"<button type='button' class='showall_icon' title='Show contents' onclick='expandPanel(this);'>&nbsp;</button> <span class='rightpanel_header_text'>Publication info":"<button type='button' class='showall_icon' title='Show contents' onclick='expandPanel(this);'>&nbsp;</button> <span class='rightpanel_header_text'>Contestants",e+="</span>",d.innerHTML=e;var g=document.createElement("div");return g.className="rightpanel_content",b.appendChild(d),b.appendChild(g),b}function createFileOpenSubPanel(a,b){var e=document.createElement("div"),g=document.createElement("div");g.className="rightpanel_subcontentholder";var k="<button type='button' class='hideall_icon' title='Show all revisions' onclick='expandTest(this, \""+a+"\");'>&nbsp;</button> <span id='testname' onclick='getData(this)' test='"+a+"' revision='LATEST' class='rightpanel_subcontentholder_content'>"+a+"&emsp;<span class='rightpanel_content_italic'>"+b;return k+=2>b?" revision":" revisions",k+="</span></span>",g.innerHTML=k,g}function stringToDom(a){var b=new DOMParser;return b.parseFromString(a,"text/html")}function saveData(){var a=[],b=document.querySelectorAll("#questionholder div.questionholder");let d=b.length;for(console.log(b.length),i=0;i<d;i++){var e=document.getElementById("input_title_q"+i).value,g={id:i,title:e},k=[],m=document.getElementById("q"+i+"_holder").childNodes;for(j=0;j<m.length-2;j++){var n=document.getElementById("input_answer_q"+i+"_a"+j).value,q=document.getElementById("chb_q"+i+"_a"+j).checked;k.push({title:n,correct:q})}g.answers=k,a.push(g)}var s=JSON.stringify(a);console.log(s),sendData(s)}function sendData(a){var b=document.getElementById("test_name").value;b=b.replace(/\s+/g,"_").toLowerCase();var d=new Date,e="";e+=d.getDate()+"_",e+=d.getMonth()+"_",e+=d.getFullYear()+"_",e+=d.getHours()+"_"+d.getMinutes()+"_"+d.getSeconds(),currenttest=b,rev=e,fetch("savefile.php?name="+b+"&save="+e+"&data="+a).then(function(g){return g.ok?g.text():void(document.getElementById("lastsaved").innerHTML="An error occured while saving: "+g.status+" - "+g.statusText)}).then(function(){document.getElementById("lastsaved").innerHTML=e})}function saveContestants(){var a=[];document.getElementById("questionholder");if(0===currentid){let k=document.getElementById("titleholder_c0").innerHTML;var d={};d[k]=[];let m=document.getElementById("c0");for(var e=2;e<m.childNodes.length;e++){let n=m.childNodes[e].lastChild.value;d[k].push(n)}a.push(d)}else for(var g=0;g<currentid;){let k=document.getElementById("titleholder_c"+g).innerHTML;var d={};d[k]=[];let m=document.getElementById("c"+g);for(var e=2;e<m.childNodes.length;e++){let n=m.childNodes[e].lastChild.value;d[k].push(n)}a.push(d)}sendContestantData(JSON.stringify(a))}function sendContestantData(a){console.log(a),fetch("updatecontestants.php?data="+a).then(function(b){if(b.ok)return b.status}).then(function(b){console.log(b)})}window.onload=function(){listFiles()};function writeJsDebug(a){jsDebugText=a+"",jsDebugOutput=document.getElementById("editorfooter"),jsDebugOutput.innerHTML+=jsDebugText+" | "}function writeJsNewLine(){document.getElementById("editorfooter").innerHTML+=" ~ | "}var qidCount=0;function newqid(){return newQid="q"+qidCount,qidCount++,newQid}function newaid(a){return parentIdHolder=a+"_holder",aidCount=document.getElementById(parentIdHolder).childElementCount,aidCountNew=aidCount-2,a+="_a"+aidCountNew,a}function addquestion(a){if(emptyquestion=document.createElement("div"),emptyquestion.id=newqid(),emptyquestion.className="questionholder",qid=emptyquestion.id,emptyquestion.title=qid,emptyquestion.innerHTML="undefined"==typeof a?"<div><button type=\"button\" class=\"bttntoggleq-hide\" title=\"Hide\" id=\"bttntoggleq_"+qid+"\" onclick=\"togglequestion('"+qid+"');\">&nbsp;</button><button type=\"button\" class=\"delete_icon\" title=\"Remove question\" onclick=\"removequestion(this)\">&nbsp;</button>&emsp;<span id=\"titleholder_"+qid+"\" class=\"titleholder\"></span></div><div id=\""+qid+"_holder\" class=\"question_holder\"><button type=\"button\" class=\"add_icon\" title=\"Add answer\" onclick=\"addanswer('"+qid+"');\">&nbsp;</button><input type=\"text\" placeholder=\"Set title\" onKeyUp=\"updateTitle('"+qid+"');\" id=\"input_title_"+qid+"\"></div>":"<div><button type=\"button\" class=\"bttntoggleq-hide\" title=\"Hide\" id=\"bttntoggleq_"+qid+"\" onclick=\"togglequestion('"+qid+"');\">&nbsp;</button><button type=\"button\" class=\"delete_icon\" title=\"Remove question\" onclick=\"removequestion(this)\">&nbsp;</button>&emsp;<span id=\"titleholder_"+qid+"\" class=\"titleholder\">"+a+"</span></div><div id=\""+qid+"_holder\" class=\"question_holder\"><button type=\"button\" class=\"add_icon\" title=\"Add answer\" onclick=\"addanswer('"+qid+"');\">&nbsp;</button><input type=\"text\" placeholder=\"Set title\" onKeyUp=\"updateTitle('"+qid+"');\" id=\"input_title_"+qid+"\" value = \""+a+"\"></div>",document.getElementById("questionholder").appendChild(emptyquestion),updateTitle(qid),togglequestion(qid),"undefined"!=typeof a)return qid}function removequestion(a){writeJsNewLine();var b=a.parentNode.parentNode,d=a.parentNode.parentNode.parentNode,e=confirm("You are about to remove the question.\nAre you sure?");if(!0==e){var g=document.getElementById(b.id);g.parentNode.removeChild(g);var k=document.getElementById(d.id).childNodes,m;for(m=0;m<k.length;m++)newi=m--,writeJsDebug(m),writeJsDebug(newi),k[m].id="q"+newi,k[m].title=k[m].id,writeJsDebug(k[m].id)}}function addanswer(a,b,d){emptyanswer=document.createElement("div"),aidCount=document.getElementById(a).childElementCount,emptyanswer.id=newaid(a),emptyanswer.className="answerholder",aid=emptyanswer.id,emptyanswer.title=aid,"undefined"==typeof b?(emptyanswer.innerHTML="<button type=\"button\" class=\"delete_icon\" title=\"Remove answer\" onclick=\"removeanswer(this);\">&nbsp;</button><input type=\"checkbox\" class=\"correctanswer\" id=\"chb_"+aid+"\" /><label class=\"chb_label\" title=\"Answer is right\" for=\"chb_"+aid+"\"></label><input type=\"text\" placeholder=\"Answer\" id=\"input_answer_"+aid+"\">",document.getElementById(a+"_holder").appendChild(emptyanswer)):(emptyanswer.innerHTML="<button type=\"button\" class=\"delete_icon\" title=\"Remove answer\" onclick=\"removeanswer(this);\">&nbsp;</button><input type=\"checkbox\" class=\"correctanswer\" id=\"chb_"+aid+"\" /><label class=\"chb_label\" title=\"Answer is right\" for=\"chb_"+aid+"\"></label><input type=\"text\" placeholder=\"Answer\" value=\""+b+"\" id=\"input_answer_"+aid+"\">",document.getElementById(a+"_holder").appendChild(emptyanswer),document.getElementById("chb_"+aid).checked=d)}function removeanswer(a){var b=a.parentNode.parentNode,d=a.parentNode.parentNode.parentNode,e=document.getElementById(a.parentNode.id);e.parentNode.removeChild(e);var g=document.getElementById(b.id).childNodes,k;for(k=2;k<g.length;k++){var m=k-2;g[k].id=d.id+"_a"+m,g[k].title=g[k].id}}function togglequestion(a){questionToggleStatus=document.getElementById(a+"_holder").style.display,"none"===questionToggleStatus?(document.getElementById(a+"_holder").style.display="block",document.getElementById("bttntoggleq_"+a).className="bttntoggleq-hide",document.getElementById("bttntoggleq_"+a).title="Hide"):(document.getElementById(a+"_holder").style.display="none",document.getElementById("bttntoggleq_"+a).className="bttntoggleq-show",document.getElementById("bttntoggleq_"+a).title="Show")}function showall(){var b=document.getElementById("questionholder").childNodes,d;for(d=0;d<b.length;d++){var e=document.getElementById(b[d].id+"_holder").style.display;if("none"===e){var g=b[d].id;document.getElementById(g+"_holder").style.display="block",document.getElementById("bttntoggleq_"+g).className="bttntoggleq-hide",document.getElementById("bttntoggleq_"+g).title="Hide"}}}function hideall(){var b=document.getElementById("questionholder").childNodes,d;for(d=0;d<b.length;d++){var e=document.getElementById(b[d].id+"_holder").style.display;if("none"!==e){var g=b[d].id;document.getElementById(g+"_holder").style.display="none",document.getElementById("bttntoggleq_"+g).className="bttntoggleq-show",document.getElementById("bttntoggleq_"+g).title="Show"}}}function updateTitle(a){var b=document.getElementById("input_title_"+a).value;""===b&&(b="<span class='error' title='Please add a title for this question'>No Title</span>"),document.getElementById("titleholder_"+a).innerHTML=b}function expandPanel(a){var b=a.parentNode.parentNode;b.hasAttribute("type")&&(attr=b.getAttribute("type"),"contestants"===b.getAttribute("type")?initContestantEditor():loadPublishInfo());for(var d=a.parentNode.parentNode,e=d.childNodes,g=0;g<e.length;g++)"rightpanel_content"===e[g].className&&(e[g].style.display="block");a.className="showall_icon",a.onclick=function(){collapsePanel(this)}}function collapsePanel(a){for(var b=a.parentNode.parentNode,d=b.childNodes,e=0;e<d.length;e++)"rightpanel_content"===d[e].className&&(d[e].style.display="none");a.className="hideall_icon",a.onclick=function(){expandPanel(this)}}function expandTest(a,b){var d=a.parentNode,e=d.childNodes;3===e.length&&getFileRevisions(b,d);for(var g=3;g<e.length;g++)e[g].style&&(e[g].style.display="block");a.className="showall_icon",a.onclick=function(){collapseTest(this)}}function collapseTest(a){for(var b=a.parentNode,d=b.childNodes,e=3;e<d.length;e++)d[e].style&&(d[e].style.display="none");a.className="hideall_icon",a.onclick=function(){expandTest(this)}}function cleareditor(){document.getElementById("questionholder").innerHTML="",qidCount=0}function backtoeditor(){saveContestants(),cleareditor();let a=document.getElementById("add");a.title="Add question",a.onclick=addquestion;let b=document.getElementById("save");b.title="Save test",b.className="save_icon",b.onclick=saveData;document.getElementById("questionholder");document.getElementById("questionholder").innerHTML=sessionStorage.getItem("lasteditedtest")}function initContestantEditor(){let a=document.getElementById("questionholder").innerHTML;sessionStorage.lasteditedtest=a,cleareditor();let b=document.getElementById("add");b.title="Add group",b.onclick=addgroup;let d=document.getElementById("save");d.title="Back to testeditor",d.className="back_icon",d.onclick=backtoeditor,listContestants()}function publishTest(){saveData();let a=new FormData;a.set("test",currenttest),a.set("revision",rev),fetch("publishtest.php",{method:"POST",body:a}).then(function(b){if(b.ok)return b.json()}).then(function(){})}